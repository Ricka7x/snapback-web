name: Generate Appcast

on:
  push:
    paths:
      - 'releases/**'
  workflow_dispatch:
    inputs:
      sparkle_path:
        description: 'Path to Sparkle bin directory'
        required: false

jobs:
  generate-appcast:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Sparkle binary
        id: sparkle
        run: |
          # Look for generate_appcast in common locations
          if [ -f "/Users/ricka7x/Library/Developer/Xcode/DerivedData/Snapback-cgktvwlfyvupbvbgwoktbwlrhxnq/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_appcast" ]; then
            echo "bin_path=/Users/ricka7x/Library/Developer/Xcode/DerivedData/Snapback-cgktvwlfyvupbvbgwoktbwlrhxnq/SourcePackages/artifacts/sparkle/Sparkle/bin" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Sparkle binary not found in default location"
            echo "bin_path=" >> $GITHUB_OUTPUT
          fi

      - name: Generate appcast
        if: steps.sparkle.outputs.bin_path != ''
        run: |
          SPARKLE_BIN="${{ steps.sparkle.outputs.bin_path }}"
          RELEASES_DIR="$PWD/releases"
          
          "$SPARKLE_BIN/generate_appcast" \
            --download-url-prefix "https://snapbackapp.com/releases" \
            --link "https://snapbackapp.com" \
            "$RELEASES_DIR"

      - name: Commit appcast
        if: steps.sparkle.outputs.bin_path != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add releases/appcast.xml
          if ! git diff --quiet --cached; then
            git commit -m "chore: update appcast.xml"
            git push
          else
            echo "No changes to appcast.xml"
          fi
